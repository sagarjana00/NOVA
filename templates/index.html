<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nova</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Markdown parser - marked.js (very fast & secure) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Code syntax highlighting - highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Optional: Math rendering (uncomment if needed) -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" /> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script> -->
    <style>
        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #121212;
            --bg-tertiary: #1a1a1f;
            --bg-input: #0f0f11;
            --text-primary: #f1f1f3;
            --text-secondary: #b0b0b8;
            --text-muted: #6e6e78;
            --btn-primary-bg: #7c3aed;
            --btn-primary-hover: #6d28d9;
            --btn-primary-fg: #ffffff;
            --btn-secondary-bg: #1e1e24;
            --btn-secondary-hover: #2a2a32;
            --border: #1e1e24;
            --border-light: #2a2a32;
            --error: #f87171;
            --success: #34d399;
            --accent: #a78bfa;
            --sidebar-width: 280px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            gap: 1rem;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .new-chat-btn {
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover));
            color: var(--btn-primary-fg);
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(124, 58, 237, 0.4);
        }

        .quiz-page-btn {
            margin-top: 0.75rem;
            background: var(--btn-secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
            text-decoration: none;
        }

        .quiz-page-btn:hover {
            transform: translateY(-2px);
            background: var(--btn-secondary-hover);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }


        .chat-history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-right: 0.5rem;
        }

        .chat-history-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .chat-history-item {
            padding: 0.85rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item:hover {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .chat-history-item.active {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
            border-left: 3px solid var(--btn-primary-bg);
        }

        /* Main Chat Area */
        .chat-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0d0d0f 100%);
        }

        #nova-tagline {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.2rem;
            font-weight: 300;
            background: linear-gradient(135deg, #f1f1f3, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: none;
            letter-spacing: -0.5px;
        }

        #nova-tagline.minimized {
            top: 2rem;
            left: 2rem;
            transform: translate(0, 0);
            font-size: 1.3rem;
            font-weight: 700;
            opacity: 0.9;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            margin-top: 4rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding-bottom: 2rem;
            padding-right: 1rem;
        }

        #chat-history::-webkit-scrollbar {
            width: 8px;
        }

        #chat-history::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        /* Messages */
        .message-output {
            position: relative;
            padding: 1.25rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 85%;
            animation: fadeIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            margin-bottom: 2.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .message-output.user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover));
            border: none;
            color: var(--btn-primary-fg);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .message-output.bot {
            align-self: flex-start;
            background: var(--bg-tertiary);
        }

        .message-output.editing {
            background: var(--bg-input);
            border: 2px solid var(--btn-primary-bg);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* User Message Actions */
        .user-message-actions, .message-actions {
            position: absolute;
            bottom: -2.75rem;
            display: flex;
            gap: 0.4rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            background: var(--bg-tertiary);
            padding: 0.5rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .user-message-actions { right: 0; }

        .message-output.user:hover .user-message-actions,
        .message-output.bot:hover .message-actions {
            opacity: 1;
        }

        .user-message-actions button, .message-actions button {
            background: transparent;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .user-message-actions button:hover, .message-actions button:hover {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .edit-textarea {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            line-height: 1.6;
        }

        .edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            justify-content: flex-end;
        }

        .edit-actions button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-save { background: var(--btn-primary-bg); color: white; }
        .btn-save:hover { background: var(--btn-primary-hover); }
        .btn-cancel { background: var(--btn-secondary-bg); color: var(--text-secondary); }
        .btn-cancel:hover { background: var(--btn-secondary-hover); }

        /* Response Versions */
        .response-versions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .version-btn {
            padding: 0.5rem 1rem;
            background: var(--btn-secondary-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .version-btn:hover {
            background: var(--btn-secondary-hover);
            color: var(--text-primary);
        }

        .version-btn.active {
            background: var(--btn-primary-bg);
            color: white;
            border-color: var(--btn-primary-bg);
        }

        .message-actions { left: 0; }

        /* Input Area */
        .input-container {
            position: relative;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 0.75rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            transition: border-color 0.2s;
        }

        .input-container:focus-within {
            border-color: var(--btn-primary-bg);
        }

        #prompt-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0.5rem;
            font-size: 1rem;
            resize: none;
            line-height: 1.6;
            min-height: 1.6rem;
            max-height: 400px;
            background: transparent;
            color: var(--text-primary);
            font-family: inherit;
            overflow-y: auto;
        }

        #prompt-input::-webkit-scrollbar {
            width: 6px;
        }

        #prompt-input::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .send-btn {
            background: linear-gradient(135deg, var(--btn-primary-bg), var(--btn-primary-hover));
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--btn-primary-fg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(124, 58, 237, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 0.5rem 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            30% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Model Badge Popup */
        .model-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.9), rgba(109, 40, 217, 0.9));
            color: white;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            animation: modelBadgeAppear 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .model-badge:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 16px rgba(124, 58, 237, 0.6);
        }

        @keyframes modelBadgeAppear {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Model Tooltip */
        .model-tooltip {
            position: absolute;
            top: -3rem;
            right: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-light);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 20;
        }

        .model-badge:hover .model-tooltip {
            opacity: 1;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .connection-status.connected {
            background: var(--success);
            color: white;
        }

        .connection-status.disconnected {
            background: var(--error);
            color: white;
        }
        /* Better markdown rendering */
.message-text {
    line-height: 1.6;
    word-break: break-word;
}

.message-text p { margin: 0.8em 0; }
.message-text ul, .message-text ol { padding-left: 1.8em; margin: 0.8em 0; }
.message-text li { margin: 0.4em 0; }
.message-text blockquote {
    border-left: 4px solid var(--border);
    padding-left: 1rem;
    margin: 1rem 0;
    color: var(--text-secondary);
}

.message-text code {
    background: #1e1e24;
    padding: 0.2em 0.5em;
    border-radius: 4px;
    font-family: 'Consolas', 'Monaco', monospace;
}

.message-text pre {
    background: #0d0d0f;
    padding: 1rem;
    border-radius: 10px;
    overflow-x: auto;
    position: relative;
    margin: 1rem 0;
}

.message-text pre code {
    background: none;
    padding: 0;
}

.code-copy-btn {
    position: absolute;
    top: 0.8rem;
    right: 0.8rem;
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--text-secondary);
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
}

.message-text pre:hover .code-copy-btn {
    opacity: 1;
}

.code-copy-btn:hover {
    background: rgba(255,255,255,0.2);
    color: var(--text-primary);
}

/* Text Formatting Toolbar */
.formatting-toolbar {
    display: flex;
    gap: 0.4rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
}

.formatting-btn {
    background: var(--btn-secondary-bg);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
}

.formatting-btn:hover {
    background: var(--btn-secondary-hover);
    color: var(--text-primary);
    border-color: var(--btn-primary-bg);
}

.formatting-btn.active {
    background: var(--btn-primary-bg);
    color: white;
    border-color: var(--btn-primary-bg);
}

/* ============================= */
/* Responsive Design */
/* ============================= */

/* Tablets & small laptops */
@media (max-width: 1024px) {
    :root {
        --sidebar-width: 240px;
    }

    .chat-wrapper {
        padding: 1.5rem;
    }

    #chat-history {
        margin-top: 3.5rem;
    }
}

/* ============================= */
/* Mobile Devices */
/* ============================= */
@media (max-width: 768px) {

    /* Messages */
    .message-output {
        max-width: 95%;
        padding: 1rem;
        border-radius: 14px;
        font-size: 0.95rem;
    }

    .user-message-actions,
    .message-actions {
        bottom: -2.2rem;
        gap: 0.3rem;
        padding: 0.4rem;
    }

    /* Input area */
    .input-container {
        border-radius: 14px;
        padding: 0.6rem;
        gap: 0.5rem;
    }

    #prompt-input {
        font-size: 0.95rem;
        max-height: 250px;
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
    }

    /* Connection status */
    .connection-status {
        top: auto;
        bottom: 1rem;
        right: 1rem;
        font-size: 0.75rem;
        padding: 0.4rem 0.7rem;
    }
}



/* ============================= */
/* Extra Small Phones */
/* ============================= */
@media (max-width: 480px) {

    .logo {
        font-size: 1.15rem;
    }

    .new-chat-btn i {
        margin-right: 0;
    }

    .new-chat-btn span {
        display: none;
    }

    .message-output {
        font-size: 0.9rem;
    }

    .code-copy-btn {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
    }
}

/* ============================= */
/* Mobile History Toggle */
/* ============================= */

.mobile-history-btn {
    display: none;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 1.2rem;
    cursor: pointer;
}

/* ============================= */
/* Mobile Sidebar Drawer */
/* ============================= */
@media (max-width: 768px) {

    body {
        overflow: hidden;
    }

    .mobile-history-btn {
        display: block;
    }

    /* Sidebar as drawer */
    .sidebar {
        position: fixed;
        top: 0;
        left: -100%;
        width: 80%;
        max-width: 320px;
        height: 100vh;
        flex-direction: column;
        padding: 1rem;
        z-index: 2000;
        transition: left 0.3s ease;
    }

    .sidebar.open {
        left: 0;
    }

    .chat-history-list {
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .new-chat-btn {
        width: 100%;
    }

    .chat-wrapper {
        padding: 1rem;
        padding-top: 3.5rem; /* space for hamburger button */
    }

}


/* Hide mobile topbar on desktop */
.mobile-topbar {
    display: none;
}



/* ============================= */
/* Mobile Topbar Fix */
/* ============================= */
@media (max-width: 768px) {

    .mobile-topbar {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.4rem;
        position: fixed;
        top: 0.75rem;
        left: 0.75rem;
        z-index: 3000;
    }

    .mobile-logo {
        font-size: 1.2rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--btn-primary-bg), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .mobile-history-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        font-size: 1.1rem;
        padding: 0.45rem 0.65rem;
        border-radius: 8px;
    }

    .sidebar .logo {
        display: none;
    }

    #nova-tagline {
        display: none;
    }
}





    </style>
</head>
<body>

<div class="connection-status disconnected" id="connection-status">
    <i class="fa-solid fa-circle"></i>
    <span>Connecting...</span>
</div>

<div class="sidebar">
    <div class="sidebar-header" style="flex-direction:column; gap:.6rem;">
        <div class="logo">nova</div>

        <a href="/logout" style="
            color:#b0b0b8;
            font-size:.85rem;
            text-decoration:none;
            border:1px solid #1e1e24;
            padding:.35rem .8rem;
            border-radius:8px;
            transition:.2s;
        "
        onmouseover="this.style.color='#fff'"
        onmouseout="this.style.color='#b0b0b8'">
            Logout
        </a>
    </div>


    <button class="new-chat-btn" id="new-chat-btn">
        <i class="fa-solid fa-plus"></i>
        New Chat
    </button>
    <a class="quiz-page-btn" href="/quiz">
        <i class="fa-solid fa-graduation-cap"></i>
        Topic Quizzes
    </a>
    <div class="chat-history-list" id="sidebar-history">
        <!-- Chat history items will be added here -->
    </div>
</div>

<div class="chat-wrapper">

    <div class="mobile-topbar">
        <div class="mobile-logo">nova</div>
        <button class="mobile-history-btn" id="mobile-history-btn">
            <i class="fa-solid fa-bars"></i>
        </button>
    </div>


    <div id="nova-tagline">nova â€¢ Ask anything</div>
    
    <div id="chat-history"></div>

    <div class="input-container">
        <textarea id="prompt-input" rows="1" placeholder="Type your message..."></textarea>
        <button class="send-btn" id="send-btn" disabled>
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>


<script>
    // SocketIO Connection
    const socket = io();
    
    const textarea = document.getElementById('prompt-input');
    const chatHistory = document.getElementById('chat-history');
    const tagline = document.getElementById('nova-tagline');
    const sendBtn = document.getElementById('send-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const sidebarHistory = document.getElementById('sidebar-history');
    const connectionStatus = document.getElementById('connection-status');
    
    let chatSessions = [];
    let currentChatId = null;
    let messageResponses = new Map();
    let currentMessageId = null;

    // Connection Status
    socket.on('connect', () => {
        console.log('Connected to server');
        connectionStatus.className = 'connection-status connected';
        connectionStatus.innerHTML = '<i class="fa-solid fa-circle"></i><span>Connected</span>';
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        connectionStatus.className = 'connection-status disconnected';
        connectionStatus.innerHTML = '<i class="fa-solid fa-circle"></i><span>Disconnected</span>';
    });

    // Receive Messages
    socket.on('chat_message', (data) => {
        if (data.role === 'system') {
            // System messages can be shown or ignored
            console.log('System:', data.content);
        } else if (data.role === 'user') {
            // User message already added locally, skip
        } else if (data.role === 'assistant') {
            handleBotResponse(data);
        }
    });

    // Typing Indicator
    socket.on('typing', (data) => {
        if (data.status) {
            // Typing indicator already shown in handleSubmission
        } else {
            // Remove typing indicator (handled in handleBotResponse)
        }
    });

    // Auto-resize textarea
    textarea.addEventListener('input', () => {
        textarea.style.height = 'auto';
        const newHeight = Math.min(textarea.scrollHeight, 400);
        textarea.style.height = newHeight + 'px';
        
        const hasContent = textarea.value.trim().length > 0;
        sendBtn.disabled = !hasContent;
    });

    // Submit on Enter
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const val = textarea.value.trim();
            if (val) {
                handleSubmission(val);
            }
        }
    });

    // Send button
    sendBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const val = textarea.value.trim();
        if (val) {
            handleSubmission(val);
        }
    });

    // New Chat
    newChatBtn.addEventListener('click', () => {
        startNewChat();
    });


    function startNewChat() {
        chatHistory.innerHTML = '';
        currentChatId = null;
        messageResponses.clear();
        tagline.textContent = 'nova â€¢ Ask anything';
        tagline.classList.remove('minimized');
        updateSidebarHistory();
    }

    function handleSubmission(prompt, isEdit = false, originalMessageId = null) {
        if (!currentChatId) {
            currentChatId = Date.now();
            chatSessions.push({
                id: currentChatId,
                title: prompt.substring(0, 30) + (prompt.length > 30 ? '...' : ''),
                messages: []
            });
            updateSidebarHistory();
        }

        if (!tagline.classList.contains('minimized')) {
            tagline.classList.add('minimized');
            setTimeout(() => {
                tagline.textContent = 'nova';
            }, 350);
        }
        
        let userMsgDiv;
        let messageId = originalMessageId || Date.now();
        currentMessageId = messageId;
        
        if (isEdit) {
            userMsgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (userMsgDiv) {
                userMsgDiv.querySelector('.message-text').textContent = prompt;
            }
        } else {
            userMsgDiv = appendMessage(prompt, 'user', messageId);
        }
        
        textarea.value = '';
        textarea.style.height = 'auto';
        sendBtn.disabled = true;

        // Show typing indicator
        const botMsgDiv = appendMessage('', 'bot', `bot-${messageId}`);
        showTypingIndicator(botMsgDiv);

        // Send to server
        socket.emit('message', { message: prompt });
    }

    function handleBotResponse(data) {
        const botMsgId = `bot-${currentMessageId}`;
        let botMsgDiv = document.querySelector(`[data-message-id="${botMsgId}"]`);
        
        if (botMsgDiv) {
            hideTypingIndicator(botMsgDiv);
            const textEl = botMsgDiv.querySelector('.message-text');
            const content = data.content;
            const hasCode = content.includes('```');
            textEl.innerHTML = parseMarkdown(!hasCode && isLikelyCode(content) ? '```\n' + content + '\n```' : content);
            highlightCodeBlocks(textEl);
            
            // Display model badge if model information is available
            if (data.model) {
                addModelBadge(botMsgDiv, data.model);
            }
            
            if (!messageResponses.has(currentMessageId)) {
                messageResponses.set(currentMessageId, []);
            }
            messageResponses.get(currentMessageId).push(content);
            
            if (messageResponses.get(currentMessageId).length > 1) {
                addVersionSelector(botMsgDiv, currentMessageId);
            }
        }
    }

    function showTypingIndicator(messageDiv) {
        const textEl = messageDiv.querySelector('.message-text');
        textEl.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    }

    function hideTypingIndicator(messageDiv) {
        const textEl = messageDiv.querySelector('.message-text');
        textEl.innerHTML = '';
    }

    function addModelBadge(botMsgDiv, modelKey) {
        // Remove any existing badge first
        const existingBadge = botMsgDiv.querySelector('.model-badge');
        if (existingBadge) {
            existingBadge.remove();
        }
        
        // Model display names mapping
        const modelNames = {
            'model_xl': 'XL',
            'model_l': 'L',
            'model_m': 'M',
            'model_s': 'S'
        };
        
        // Model descriptions for tooltip
        const modelDescriptions = {
            'model_xl': 'Safety Analysis Model',
            'model_l': 'Complex Reasoning Model',
            'model_m': 'Cybersecurity Model',
            'model_s': 'Fast Chat Model'
        };
        
        const badge = document.createElement('div');
        badge.className = 'model-badge';
        // Extract model suffix (e.g., 'model_xl' -> 'xl') for unknown models
        const fallbackName = modelKey.replace('model_', '').toUpperCase();
        badge.textContent = modelNames[modelKey] || fallbackName;
        
        // Add tooltip
        const tooltip = document.createElement('div');
        tooltip.className = 'model-tooltip';
        tooltip.textContent = modelDescriptions[modelKey] || 'AI Model';
        badge.appendChild(tooltip);
        
        botMsgDiv.appendChild(badge);
    }

    function addVersionSelector(botMsgDiv, messageId) {
        const versions = messageResponses.get(messageId);
        let versionsContainer = botMsgDiv.querySelector('.response-versions');
        
        if (!versionsContainer) {
            versionsContainer = document.createElement('div');
            versionsContainer.className = 'response-versions';
            botMsgDiv.appendChild(versionsContainer);
        }
        
        versionsContainer.innerHTML = '';
        versions.forEach((response, index) => {
            const btn = document.createElement('button');
            btn.className = `version-btn ${index === versions.length - 1 ? 'active' : ''}`;
            btn.textContent = `Version ${index + 1}`;
            btn.onclick = () => switchVersion(botMsgDiv, messageId, index);
            versionsContainer.appendChild(btn);
        });
    }

    function switchVersion(botMsgDiv, messageId, versionIndex) {
        const txt = messageResponses.get(messageId)[versionIndex];
        const textEl = botMsgDiv.querySelector('.message-text');
        const hasCode = txt.includes('```');
        textEl.innerHTML = parseMarkdown(!hasCode && isLikelyCode(txt) ? '```\n' + txt + '\n```' : txt);
        highlightCodeBlocks(textEl);
        botMsgDiv.querySelectorAll('.version-btn').forEach((b, i) => b.classList.toggle('active', i === versionIndex));
    }

    function updateSidebarHistory() {
        sidebarHistory.innerHTML = '';
        chatSessions.slice().reverse().forEach(session => {
            const item = document.createElement('div');
            item.className = 'chat-history-item';
            if (session.id === currentChatId) {
                item.classList.add('active');
            }
            item.textContent = session.title;
            item.onclick = () => loadChatSession(session.id);
            sidebarHistory.appendChild(item);
        });
    }

    function loadChatSession(chatId) {
        currentChatId = chatId;
        updateSidebarHistory();
    }

    function enableEditMode(messageDiv, messageId) {
        const textEl = messageDiv.querySelector('.message-text');
        const originalText = textEl.textContent;
        
        messageDiv.classList.add('editing');
        
        const editTextarea = document.createElement('textarea');
        editTextarea.className = 'edit-textarea';
        editTextarea.value = originalText;
        editTextarea.rows = Math.min(originalText.split('\n').length + 1, 6);
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'edit-actions';
        actionsDiv.innerHTML = `
            <button class="btn-cancel">Cancel</button>
            <button class="btn-save">Send</button>
        `;
        
        textEl.innerHTML = '';
        textEl.appendChild(editTextarea);
        textEl.appendChild(actionsDiv);
        
        editTextarea.focus();
        
        editTextarea.addEventListener('input', () => {
            editTextarea.style.height = 'auto';
            editTextarea.style.height = editTextarea.scrollHeight + 'px';
        });
        
        actionsDiv.querySelector('.btn-cancel').onclick = () => {
            messageDiv.classList.remove('editing');
            textEl.textContent = originalText;
        };
        
        actionsDiv.querySelector('.btn-save').onclick = () => {
            const newText = editTextarea.value.trim();
            if (newText && newText !== originalText) {
                messageDiv.classList.remove('editing');
                
                let nextEl = messageDiv.nextElementSibling;
                while (nextEl) {
                    const toRemove = nextEl;
                    nextEl = nextEl.nextElementSibling;
                    toRemove.remove();
                }
                
                handleSubmission(newText, true, messageId);
            }
        };
    }

    const parseMarkdown = (txt) => marked.parse(txt, { breaks: true, gfm: true, headerIds: false, sanitize: false });
    
    function isLikelyCode(text) {
        const lines = text.trim().split('\n');
        if (lines.length < 2) return false;
        const patterns = [/^\s*(function|const|let|var|class|import|export|def|if|for|while|return)/m, /^\s*(<!DOCTYPE|<html|<script|<div|\{|\[|\(|\/\/|\/\*|#|--)/m, /[\{\}\[\]\(\);:=<>]/g];
        return patterns.reduce((c, p) => c + (text.match(p) ? 1 : 0), 0) >= 2;
    }

    function highlightCodeBlocks(el) {
        el.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
            const btn = document.createElement('button');
            btn.className = 'code-copy-btn';
            btn.innerHTML = '<i class="fa-solid fa-copy"></i>';
            btn.title = 'Copy code';
            btn.onclick = () => {
                navigator.clipboard.writeText(block.textContent);
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => btn.innerHTML = '<i class="fa-solid fa-copy"></i>', 2000);
            };
            block.parentElement.style.position = 'relative';
            block.parentElement.appendChild(btn);
        });
    }

    function appendMessage(text, role, messageId) {
        const msg = document.createElement('div');
        msg.className = `message-output ${role}`;
        msg.setAttribute('data-message-id', messageId);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-text';
        const hasCode = text.includes('```');
        contentDiv.innerHTML = parseMarkdown(!hasCode && isLikelyCode(text) ? '```\n' + text + '\n```' : text);
        msg.appendChild(contentDiv);

        highlightCodeBlocks(contentDiv);

        if (role === 'bot') {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            actions.innerHTML = `<button title="Copy" onclick="copyMessageText(this.closest('.message-output'))"><i class="fa-solid fa-copy"></i></button>
                <button title="Regenerate" onclick="regenerateResponse()"><i class="fa-solid fa-rotate-right"></i></button>
                <button title="Good" onclick="rateResponse(this, true)"><i class="fa-solid fa-thumbs-up"></i></button>
                <button title="Bad" onclick="rateResponse(this, false)"><i class="fa-solid fa-thumbs-down"></i></button>`;
            msg.appendChild(actions);
        } else {
            const actions = document.createElement('div');
            actions.className = 'user-message-actions';
            actions.innerHTML = `<button title="Edit" onclick="enableEditMode(this.closest('.message-output'), '${messageId}')"><i class="fa-solid fa-pen"></i></button>
                <button title="Copy" onclick="copyMessageText(this.closest('.message-output'))"><i class="fa-solid fa-copy"></i></button>`;
            msg.appendChild(actions);
        }

        chatHistory.appendChild(msg);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return msg;
    }
    
    function updateFormattingButtons(textEl) {
        const existing = textEl.querySelector('.formatting-toolbar');
        if (existing) existing.remove();
        
        const toolbar = document.createElement('div');
        toolbar.className = 'formatting-toolbar';
        const opts = [
            { label: 'B', title: 'Bold', selector: 'strong, b' },
            { label: 'I', title: 'Italic', selector: 'em, i' },
            { label: 'Code', title: 'Code', selector: 'code' },
            { label: 'Link', title: 'Links', selector: 'a' },
            { label: 'List', title: 'Lists', selector: 'ul, ol' },
            { label: 'Quote', title: 'Quotes', selector: 'blockquote' },
            { label: 'H', title: 'Headings', selector: 'h1, h2, h3, h4, h5, h6' }
        ];

        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'formatting-btn' + (textEl.querySelector(o.selector) ? ' active' : '');
            btn.title = o.title;
            btn.textContent = o.label;
            btn.onclick = (e) => { e.preventDefault(); showNotification(`ðŸ“ Response contains ${o.title.toLowerCase()}`); };
            toolbar.appendChild(btn);
        });
        textEl.insertBefore(toolbar, textEl.firstChild);
    }

    function findLastUserMessage() {
        const msgs = chatHistory.querySelectorAll('.message-output.user');
        return msgs.length > 0 ? msgs[msgs.length - 1] : null;
    }

    function showNotification(msg) {
        const note = document.createElement('div');
        note.textContent = msg;
        note.style.cssText = 'position:fixed;bottom:2rem;right:2rem;background:var(--bg-tertiary);color:var(--text-primary);padding:1rem 1.5rem;border-radius:10px;border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;animation:fadeIn .3s ease';
        document.body.appendChild(note);
        setTimeout(() => { note.style.opacity = '0'; note.style.transition = 'opacity .3s'; setTimeout(() => note.remove(), 300); }, 2000);
    }
    
    function copyMessageText(div) {
        const txt = div.querySelector('.message-text').textContent;
        navigator.clipboard.writeText(txt).then(() => showNotification('Message copied!'));
    }
    
    function regenerateResponse() {
        const lastMsg = findLastUserMessage();
        if (lastMsg) {
            let n = lastMsg.nextElementSibling;
            while (n) { const x = n; n = n.nextElementSibling; x.remove(); }
            handleSubmission(lastMsg.querySelector('.message-text').textContent, false, lastMsg.getAttribute('data-message-id'));
        }
    }
    
    function rateResponse(btn, isPos) {
        const ico = btn.querySelector('i');
        const act = btn.closest('.message-actions');
        act.querySelectorAll('.fa-thumbs-up, .fa-thumbs-down').forEach(i => i.style.color = '');
        if (ico.style.color !== 'var(--btn-primary-bg)') {
            ico.style.color = 'var(--btn-primary-bg)';
            showNotification(isPos ? 'Thanks for your feedback!' : 'Feedback noted');
        }
    }


        // Mobile history toggle
    const mobileHistoryBtn = document.getElementById('mobile-history-btn');

    mobileHistoryBtn?.addEventListener('click', () => {
        document.querySelector('.sidebar').classList.toggle('open');
    });

    // Close sidebar when a chat is selected (mobile UX)
    document.getElementById('sidebar-history').addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            document.querySelector('.sidebar').classList.remove('open');
        }
    });

</script>

</body>
</html>